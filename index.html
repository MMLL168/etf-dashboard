<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF å­˜è‚¡è¤‡åˆ©æˆ°æƒ…å®¤ (Google Sheet ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background-color: #ffffff; min-height: 100vh; border-right: 1px solid #dee2e6; }
        .nav-link { color: #495057; font-weight: 500; }
        .nav-link.active { background-color: #e7f1ff; color: #0d6efd; border-radius: 5px; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .growth-badge { font-size: 0.9em; padding: 5px 10px; border-radius: 20px; background-color: #d1e7dd; color: #0f5132; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
            <h5 class="text-primary mb-4"><i class="bi bi-graph-up-arrow"></i> å­˜è‚¡æˆ°æƒ…å®¤</h5>
            
            <div class="alert alert-light border mb-3 p-2">
                <small class="text-muted d-block mb-2">æ•¸æ“šä¾†æº</small>
                <button class="btn btn-success btn-sm w-100" onclick="syncGoogleSheetData()">
                    <i class="bi bi-cloud-download"></i> åŒæ­¥ Google Sheet
                </button>
                <div id="syncStatus" class="small text-muted mt-1 text-center" style="font-size: 0.8em;"></div>
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted">é¸æ“‡æˆ‘çš„æŒè‚¡</label>
                <select class="form-select" id="etfSelector" onchange="renderDashboard()">
                </select>
            </div>
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#editModal">
                    <i class="bi bi-pencil-square"></i> ç®¡ç†/æ–°å¢ ETF
                </button>
                <button class="btn btn-outline-danger btn-sm" onclick="resetData()">
                    <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®æ‰€æœ‰è³‡æ–™
                </button>
            </div>
            <hr>
            <div class="small text-muted mt-3">
                <i class="bi bi-info-circle"></i> æ•¸æ“šèªªæ˜ï¼š<br>
                æ­¤æ¨¡å‹å‡è¨­ã€Œè‚¡æ¯å†æŠ•å…¥ã€ï¼Œä¸¦æ”¯æ´é€é Google Sheet æ›´æ–°æœ€æ–°æ®–åˆ©ç‡ã€‚
            </div>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            <div class="d-md-none mb-3">
                <button class="btn btn-success w-100 mb-2" onclick="syncGoogleSheetData()">
                    <i class="bi bi-cloud-download"></i> åŒæ­¥ Google Sheet è‚¡åƒ¹
                </button>
                <select class="form-select mb-2" id="etfSelectorMobile" onchange="syncMobileSelect(this.value)">
                </select>
                <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#editModal">ç®¡ç†æŒè‚¡æ¸…å–®</button>
            </div>

            <h2 class="mb-4" id="dashboardTitle">è¼‰å…¥ä¸­...</h2>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-primary">
                        <div class="text-muted small">ç›®å‰æŒæœ‰å¼µæ•¸</div>
                        <div class="h2 fw-bold mb-0" id="currentSharesDisplay">0</div>
                        <div class="text-muted small mt-2">åˆå§‹æŠ•å…¥</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-success">
                        <div class="text-muted small">å¹³å‡å¹´åŒ–æ®–åˆ©ç‡ (é ä¼°)</div>
                        <div class="h2 fw-bold mb-0 text-success" id="yieldDisplay">0%</div>
                        <div class="text-muted small mt-2">æ•¸æ“šä¾†æºï¼š<span id="dataSourceTag">è‡ªè¨‚</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-warning">
                        <div class="text-muted small">10 å¹´å¾Œé ä¼°ç´¯ç©</div>
                        <div class="h2 fw-bold mb-0 text-warning" id="futureSharesDisplay">0</div>
                        <div class="text-muted small mt-2">ç¸½è³‡ç”¢æˆé•· <span id="growthRateDisplay"></span></div>
                    </div>
                </div>
            </div>

            <div class="card p-4 mb-4">
                <h5 class="card-title">ğŸ“Š è¤‡åˆ©æˆé•·è¦–è¦ºåŒ– (10å¹´æ¨æ¼”)</h5>
                <div class="chart-container">
                    <canvas id="compoundChart"></canvas>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="card-title">ğŸ“… å¹´åº¦æˆé•·é ä¼°è¡¨</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>å¹´åº¦</th>
                                <th>ç´¯ç©å¼µæ•¸ (Shares)</th>
                                <th>å¢åŠ å¼µæ•¸ (ä¾†è‡ªè‚¡æ¯)</th>
                                <th>æˆé•·å€ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç®¡ç†æˆ‘çš„ ETF æŠ•è³‡çµ„åˆ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info small">
                    <i class="bi bi-lightbulb"></i> åœ¨æ­¤è¼¸å…¥æ‚¨çš„æŒè‚¡ã€‚è‹¥ä½¿ç”¨ Google Sheet åŒæ­¥ï¼Œæ®–åˆ©ç‡æ¬„ä½å°‡æœƒè‡ªå‹•æ›´æ–°ã€‚
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>åç¨±</th>
                            <th>ç›®å‰å¼µæ•¸</th>
                            <th>é ä¼°æ®–åˆ©ç‡(%)</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTableBody">
                    </tbody>
                </table>
                
                <hr>
                <h6>æ–°å¢ ETF</h6>
                <div class="row g-2">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="newCode" placeholder="ä»£ç¢¼ (e.g 0050)">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="newName" placeholder="åç¨±">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="newShares" placeholder="å¼µæ•¸" step="0.1">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="newYield" placeholder="æ®–åˆ©ç‡%" step="0.1">
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="addETF()">æ–°å¢è‡³æ¸…å–®</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ”§ ä½¿ç”¨è€…è¨­å®šå€ (User Configuration)
    // è«‹å°‡ä¸‹æ–¹é€£çµæ›æˆæ‚¨ Google Sheet ç™¼å¸ƒçš„ CSV é€£çµ
    // æ ¼å¼è¦æ±‚ (5æ¬„): A:ä»£ç¢¼, B:åç¨±, C:è‚¡åƒ¹, D:é…æ¯, E:æ®–åˆ©ç‡
    // ============================================================
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4QoHaM5u03EpqWIbYkJaj749HPEzD3VwQQMvxDzjcOKYU-NWFiZymKwLpBWhLcGQdhZtqMigya-sN/pub?output=csv'; 

    // 1. é è¨­è³‡æ–™
    const defaultPortfolio = [
        { id: '00878', name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', shares: 10, yield: 6.5, source: 'default' },
        { id: '0056',  name: 'å…ƒå¤§é«˜è‚¡æ¯',    shares: 5,  yield: 7.2, source: 'default' },
        { id: '00919', name: 'ç¾¤ç›Šç²¾é¸é«˜æ¯',  shares: 8,  yield: 8.5, source: 'default' },
        { id: '00713', name: 'å…ƒå¤§é«˜æ¯ä½æ³¢',  shares: 3,  yield: 5.8, source: 'default' }
    ];

    let portfolio = [];
    let chartInstance = null;

    // 2. åˆå§‹åŒ–
    window.onload = function() {
        loadData();
        updateSelectors();
        renderEditTable();
        renderDashboard();
    };

    // 3. Google Sheet åŒæ­¥é‚è¼¯ (æ–°åŠŸèƒ½)
    async function syncGoogleSheetData() {
        const statusDiv = document.getElementById('syncStatus');
        
        if (GOOGLE_SHEET_CSV_URL.includes('æ‚¨çš„é€£çµ')) {
            alert('è«‹å…ˆç·¨è¼¯ç¨‹å¼ç¢¼ï¼Œå¡«å…¥æ­£ç¢ºçš„ Google Sheet CSV é€£çµï¼');
            return;
        }

        statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ­£åœ¨åŒæ­¥...';
        
        try {
            // åŠ ä¸Š timestamp é˜²æ­¢å¿«å–
            const response = await fetch(GOOGLE_SHEET_CSV_URL + '&t=' + Date.now());
            if (!response.ok) throw new Error("ç¶²è·¯é€£ç·šå¤±æ•—");
            
            const csvText = await response.text();
            const rows = csvText.split('\n');
            let updateCount = 0;

            // è§£æ CSV (å¾ç¬¬ 2 è¡Œé–‹å§‹ï¼Œè·³éæ¨™é¡Œ)
            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',');
                if (cols.length < 5) continue; // ç¢ºä¿æ¬„ä½è¶³å¤ 

                const sheetId = cols[0].trim();
                // å‡è¨­ E æ¬„ (index 4) æ˜¯æ®–åˆ©ç‡ï¼ŒD æ¬„ (index 3) æ˜¯é…æ¯ï¼ŒC æ¬„ (index 2) æ˜¯è‚¡åƒ¹
                // é€™è£¡æˆ‘å€‘ä¸»è¦æ›´æ–°æ®–åˆ©ç‡ï¼Œå› ç‚ºé€™æ˜¯è¤‡åˆ©è¨ˆç®—çš„ä¾æ“š
                const sheetYield = parseFloat(cols[4]); 

                // æ¯”å°ç¾æœ‰ Portfolio
                const target = portfolio.find(p => p.id == sheetId);
                if (target && !isNaN(sheetYield)) {
                    target.yield = sheetYield;
                    target.source = 'GoogleSheet'; // æ¨™è¨˜ä¾†æº
                    updateCount++;
                }
            }

            saveData(); // å„²å­˜æ›´æ–°å¾Œçš„è³‡æ–™
            statusDiv.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> å·²æ›´æ–° ${updateCount} æª”è³‡æ–™`;
            
            // é‡æ–°æ¸²æŸ“ç•«é¢
            renderEditTable();
            renderDashboard();

        } catch (error) {
            console.error(error);
            statusDiv.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> åŒæ­¥å¤±æ•—`;
            alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Sheet æ¬Šé™æ˜¯å¦å·²è¨­ç‚ºã€Œå…¬é–‹ç™¼å¸ƒè‡³ç¶²è·¯ (CSV)ã€ã€‚");
        }
    }

    // 4. è³‡æ–™å­˜å– (LocalStorage)
    function loadData() {
        const stored = localStorage.getItem('myETFPortfolio');
        if (stored) {
            portfolio = JSON.parse(stored);
        } else {
            portfolio = JSON.parse(JSON.stringify(defaultPortfolio));
        }
    }

    function saveData() {
        localStorage.setItem('myETFPortfolio', JSON.stringify(portfolio));
        updateSelectors();
        renderEditTable();
        renderDashboard();
    }

    function resetData() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿè‡ªå®šç¾©è³‡æ–™å°‡æ¶ˆå¤±ã€‚")) {
            localStorage.removeItem('myETFPortfolio');
            loadData();
            updateSelectors();
            renderEditTable();
            renderDashboard();
        }
    }

    // 5. UI æ›´æ–°é‚è¼¯
    function updateSelectors() {
        const sel = document.getElementById('etfSelector');
        const selMobile = document.getElementById('etfSelectorMobile');
        sel.innerHTML = '';
        selMobile.innerHTML = '';

        portfolio.forEach((etf, index) => {
            const option = `<option value="${index}">${etf.id} ${etf.name}</option>`;
            sel.innerHTML += option;
            selMobile.innerHTML += option;
        });
    }

    function syncMobileSelect(val) {
        document.getElementById('etfSelector').value = val;
        renderDashboard();
    }

    function renderEditTable() {
        const tbody = document.getElementById('portfolioTableBody');
        tbody.innerHTML = '';
        
        portfolio.forEach((etf, index) => {
            const sourceBadge = etf.source === 'GoogleSheet' 
                ? '<span class="badge bg-success rounded-pill" style="font-size:0.6em">Auto</span>' 
                : '';
            
            tbody.innerHTML += `
                <tr>
                    <td>${etf.id}</td>
                    <td>${etf.name}</td>
                    <td><input type="number" class="form-control form-control-sm" style="width: 80px" value="${etf.shares}" onchange="updateItem(${index}, 'shares', this.value)"></td>
                    <td>
                        <div class="input-group input-group-sm" style="width: 100px">
                            <input type="number" class="form-control" value="${etf.yield}" onchange="updateItem(${index}, 'yield', this.value)">
                            ${sourceBadge ? '<span class="input-group-text p-1"><i class="bi bi-lightning-fill text-warning"></i></span>' : ''}
                        </div>
                    </td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteItem(${index})"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
        });
    }

    // 6. CRUD æ“ä½œ
    function addETF() {
        const code = document.getElementById('newCode').value;
        const name = document.getElementById('newName').value;
        const shares = parseFloat(document.getElementById('newShares').value);
        const yld = parseFloat(document.getElementById('newYield').value);

        if (code && name && !isNaN(shares) && !isNaN(yld)) {
            portfolio.push({ id: code, name: name, shares: shares, yield: yld, source: 'manual' });
            saveData();
            document.getElementById('newCode').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newShares').value = '';
            document.getElementById('newYield').value = '';
        } else {
            alert("è«‹å¡«å¯«å®Œæ•´è³‡è¨Šï¼");
        }
    }

    function updateItem(index, field, value) {
        portfolio[index][field] = parseFloat(value);
        if(field === 'yield') portfolio[index].source = 'manual'; // å¦‚æœæ‰‹å‹•æ”¹ï¼Œå°±å–æ¶ˆè‡ªå‹•æ¨™è¨˜
        saveData();
    }

    function deleteItem(index) {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤ ETFï¼Ÿ")) {
            portfolio.splice(index, 1);
            saveData();
        }
    }

    // 7. æ ¸å¿ƒè¨ˆç®—èˆ‡ç¹ªåœ–
    function renderDashboard() {
        const index = document.getElementById('etfSelector').value || 0;
        if (portfolio.length === 0) return;
        
        const target = portfolio[index];
        const startShares = target.shares;
        const rate = target.yield / 100;

        // UI æ¨™é¡Œæ›´æ–°
        document.getElementById('dashboardTitle').innerHTML = `<span class="badge bg-primary">${target.id}</span> ${target.name} å­˜è‚¡åˆ†æ`;
        document.getElementById('currentSharesDisplay').innerText = startShares.toFixed(2) + " å¼µ";
        document.getElementById('yieldDisplay').innerText = target.yield + "%";
        
        const srcTag = document.getElementById('dataSourceTag');
        if(target.source === 'GoogleSheet') {
            srcTag.innerHTML = '<span class="badge bg-success">Google Sheet åŒæ­¥</span>';
        } else {
            srcTag.innerHTML = '<span class="badge bg-secondary">æ‰‹å‹•è¼¸å…¥</span>';
        }

        // è¨ˆç®—è¤‡åˆ©
        let labels = [];
        let dataShares = [];
        let projectionHTML = '';
        let current = startShares;
        const targetYears = [1, 2, 3, 4, 5, 10];

        for (let year = 1; year <= 10; year++) {
            let prev = current;
            current = current * (1 + rate);
            let diff = current - prev;
            
            labels.push(`ç¬¬ ${year} å¹´`);
            dataShares.push(current.toFixed(2));
            
            const isMilestone = targetYears.includes(year);
            const rowClass = isMilestone ? "table-primary fw-bold" : "";
            
            projectionHTML += `
                <tr class="${rowClass}">
                    <td>${year} å¹´å¾Œ</td>
                    <td>${current.toFixed(2)} å¼µ</td>
                    <td class="text-success">+${diff.toFixed(2)} å¼µ</td>
                    <td>${((current / startShares) * 100).toFixed(0)}%</td>
                </tr>
            `;
        }

        document.getElementById('projectionTable').innerHTML = projectionHTML;
        document.getElementById('futureSharesDisplay').innerText = dataShares[9] + " å¼µ";
        
        const totalGrowth = ((dataShares[9] - startShares) / startShares * 100).toFixed(1);
        document.getElementById('growthRateDisplay').innerHTML = `<span class="growth-badge">+${totalGrowth}%</span>`;

        // ç¹ªåœ–
        const ctx = document.getElementById('compoundChart').getContext('2d');
        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç´¯ç©å¼µæ•¸ (Total Shares)',
                    data: dataShares,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    yAxisID: 'y',
                }, {
                    type: 'line',
                    label: 'æˆé•·è¶¨å‹¢',
                    data: dataShares,
                    borderColor: '#ffc107',
                    borderWidth: 3,
                    tension: 0.4,
                    pointBackgroundColor: '#fff',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: 'å¼µæ•¸' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) { return context.dataset.label + ': ' + context.raw + ' å¼µ'; }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>

