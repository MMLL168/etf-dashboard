<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF å­˜è‚¡è¤‡åˆ©æˆ°æƒ…å®¤ (Pro ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background-color: #ffffff; min-height: 100vh; border-right: 1px solid #dee2e6; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .growth-badge { font-size: 0.9em; padding: 5px 10px; border-radius: 20px; background-color: #d1e7dd; color: #0f5132; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
            <h5 class="text-primary mb-4"><i class="bi bi-graph-up-arrow"></i> å­˜è‚¡æˆ°æƒ…å®¤</h5>
            
            <div class="card mb-3 border-primary">
                <div class="card-header bg-primary text-white small py-1 fw-bold">
                    <i class="bi bi-cloud-upload"></i> æ–°å¢/å„²å­˜è‡³é›²ç«¯
                </div>
                <div class="card-body p-2">
                    <div class="mb-2">
                        <label class="form-label small mb-1 text-muted">ETF æœå°‹ (ä»£ç¢¼/åç¨±)</label>
                        <input class="form-control form-control-sm" list="etfOptions" id="inputCode" placeholder="è¼¸å…¥ 00..." onchange="autoFillName()">
                        <datalist id="etfOptions">
                            </datalist>
                        <input type="hidden" id="inputName">
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="inputShares" placeholder="å¼µæ•¸" step="0.1">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="inputCost" placeholder="æˆæœ¬(é¸å¡«)">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" id="btnSave" onclick="saveToGoogleSheet()">
                        <span id="btnText">å„²å­˜è¨­å®š</span>
                    </button>
                </div>
            </div>

            <div class="alert alert-light border mb-3 p-2">
                <small class="text-muted d-block mb-2">æ›´æ–°å¸‚å ´æ•¸æ“š (æ®–åˆ©ç‡)</small>
                <button class="btn btn-success btn-sm w-100" onclick="syncGoogleSheetData()">
                    <i class="bi bi-cloud-download"></i> åŒæ­¥ Google Sheet
                </button>
                <div id="syncStatus" class="small text-muted mt-1 text-center" style="font-size: 0.8em;"></div>
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted">é¸æ“‡æˆ‘çš„æŒè‚¡</label>
                <select class="form-select" id="etfSelector" onchange="renderDashboard()">
                </select>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-outline-danger btn-sm" onclick="resetData()">
                    <i class="bi bi-arrow-counterclockwise"></i> é‡ç½®æœ¬æ©Ÿå¿«å–
                </button>
            </div>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#mobileSaveModal">
                    <i class="bi bi-cloud-upload"></i> æ–°å¢æŒè‚¡
                </button>
                <select class="form-select mb-2" id="etfSelectorMobile" onchange="syncMobileSelect(this.value)">
                </select>
            </div>

            <h2 class="mb-4" id="dashboardTitle">è¼‰å…¥ä¸­...</h2>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-primary">
                        <div class="text-muted small">ç›®å‰æŒæœ‰å¼µæ•¸</div>
                        <div class="h2 fw-bold mb-0" id="currentSharesDisplay">0</div>
                        <div class="text-muted small mt-2">åˆå§‹æŠ•å…¥ / æˆæœ¬: <span id="costDisplay">-</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-success">
                        <div class="text-muted small">å¹³å‡å¹´åŒ–æ®–åˆ©ç‡ (é ä¼°)</div>
                        <div class="h2 fw-bold mb-0 text-success" id="yieldDisplay">0%</div>
                        <div class="text-muted small mt-2">æ•¸æ“šä¾†æºï¼š<span id="dataSourceTag">è‡ªè¨‚</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-warning">
                        <div class="text-muted small">10 å¹´å¾Œé ä¼°ç´¯ç©</div>
                        <div class="h2 fw-bold mb-0 text-warning" id="futureSharesDisplay">0</div>
                        <div class="text-muted small mt-2">ç¸½è³‡ç”¢æˆé•· <span id="growthRateDisplay"></span></div>
                    </div>
                </div>
            </div>

            <div class="card p-4 mb-4">
                <h5 class="card-title">ğŸ“Š è¤‡åˆ©æˆé•·è¦–è¦ºåŒ– (10å¹´æ¨æ¼”)</h5>
                <div class="chart-container">
                    <canvas id="compoundChart"></canvas>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="card-title">ğŸ“… å¹´åº¦æˆé•·é ä¼°è¡¨</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>å¹´åº¦</th>
                                <th>ç´¯ç©å¼µæ•¸ (Shares)</th>
                                <th>å¢åŠ å¼µæ•¸ (ä¾†è‡ªè‚¡æ¯)</th>
                                <th>æˆé•·å€ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mobileSaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢/å„²å­˜è‡³é›²ç«¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ETF ä»£ç¢¼</label>
                    <input class="form-control" list="etfOptions" id="inputCodeMobile" onchange="document.getElementById('inputCode').value=this.value; autoFillName();">
                </div>
                <div class="mb-3">
                    <label class="form-label">å¼µæ•¸</label>
                    <input type="number" class="form-control" id="inputSharesMobile" onchange="document.getElementById('inputShares').value=this.value">
                </div>
                 <div class="mb-3">
                    <label class="form-label">æˆæœ¬</label>
                    <input type="number" class="form-control" id="inputCostMobile" onchange="document.getElementById('inputCost').value=this.value">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="saveToGoogleSheet();">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ”§ è¨­å®šå€ (Config)
    // ============================================================
    
    // 1. æ‚¨çš„ Google Apps Script ç¶²é æ‡‰ç”¨ç¨‹å¼ç¶²å€ (è² è²¬å­˜æª”èˆ‡è®€å–æ¸…å–®)
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwa5A867o-bWRfzoMNuufTGYE-vdkmNlYs_mE6TwshaAgD-aZQQOQuQ8DKDrVCIUyVp/exec";

    // 2. æ‚¨çš„ Google Sheet CSV ç™¼å¸ƒé€£çµ (è² è²¬åŒæ­¥æ®–åˆ©ç‡å¸‚å ´æ•¸æ“š)
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4QoHaM5u03EpqWIbYkJaj749HPEzD3VwQQMvxDzjcOKYU-NWFiZymKwLpBWhLcGQdhZtqMigya-sN/pub?output=csv'; 

    // é è¨­è³‡æ–™ (ç•¶é‚„æ²’æœ‰åŒæ­¥æ™‚é¡¯ç¤º)
    const defaultPortfolio = [
        { id: '00878', name: 'åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯', shares: 10, yield: 6.5, cost: 22.5, source: 'default' },
        { id: '0056',  name: 'å…ƒå¤§é«˜è‚¡æ¯',    shares: 5,  yield: 7.2, cost: 37.8, source: 'default' }
    ];

    let portfolio = [];
    let chartInstance = null;

    // ============================================================
    // ğŸš€ æ ¸å¿ƒé‚è¼¯
    // ============================================================

    window.onload = function() {
        loadData();         // 1. è¼‰å…¥æœ¬åœ°è³‡æ–™
        initMarketList();   // 2. è¼‰å…¥ä¸‹æ‹‰é¸å–® (å¾é›²ç«¯)
        renderDashboard();  // 3. ç¹ªè£½ç•«é¢
    };

    // --- A. é›²ç«¯å­˜å–åŠŸèƒ½ (Google Apps Script) ---

    async function initMarketList() {
        try {
            console.log("æ­£åœ¨è¼‰å…¥ ETF æ¸…å–®...");
            const res = await fetch(GAS_API_URL + "?action=getMarketList");
            const list = await res.json();
            
            const datalist = document.getElementById('etfOptions');
            datalist.innerHTML = '';
            
            list.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; 
                option.label = item.name; 
                datalist.appendChild(option);
            });
            
            window.marketData = list; 
            console.log("å…¨å¸‚å ´ ETF æ¸…å–®å·²è¼‰å…¥", list.length, "ç­†");
            
        } catch (e) {
            console.error("ç„¡æ³•è¼‰å…¥ ETF æ¸…å–®", e);
        }
    }

    function autoFillName() {
        const val = document.getElementById('inputCode').value;
        if(window.marketData) {
            const found = window.marketData.find(item => item.id === val);
            if (found) document.getElementById('inputName').value = found.name;
        }
    }

    async function saveToGoogleSheet() {
        const id = document.getElementById('inputCode').value;
        const name = document.getElementById('inputName').value || id;
        const shares = document.getElementById('inputShares').value;
        const cost = document.getElementById('inputCost').value || 0;

        if (!id || !shares) {
            alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¼µæ•¸ï¼");
            return;
        }

        const btn = document.getElementById('btnSave');
        const originalText = document.getElementById('btnText').innerText;
        btn.disabled = true;
        document.getElementById('btnText').innerText = "å„²å­˜ä¸­...";

        try {
            // å‚³é€è³‡æ–™çµ¦ GAS (ä½¿ç”¨ text/plain é¿å… CORS preflight)
            const payload = { id, name, shares, cost };
            
            await fetch(GAS_API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            
            // æˆåŠŸå¾Œæ›´æ–°æœ¬åœ°è³‡æ–™
            updateLocalPortfolio(id, name, shares, cost);
            alert(`âœ… ${id} å·²å„²å­˜è‡³é›²ç«¯ï¼`);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            document.getElementById('inputCode').value = '';
            document.getElementById('inputShares').value = '';
            document.getElementById('inputCost').value = '';

        } catch (e) {
            console.error(e);
            alert("âš ï¸ å„²å­˜è«‹æ±‚å·²ç™¼é€ (è‹¥æ²’å ±éŒ¯å³æˆåŠŸ)ã€‚\nå› è·¨åŸŸé™åˆ¶ï¼Œæœ‰æ™‚ç„¡æ³•æ¥æ”¶å›å‚³å€¼ï¼Œè«‹é‡æ–°æ•´ç†é é¢ç¢ºèªã€‚");
            // å³ä½¿å ±éŒ¯ä¹Ÿå˜—è©¦æ›´æ–°æœ¬åœ°é¡¯ç¤ºï¼Œæå‡é«”é©—
            updateLocalPortfolio(id, name, shares, cost);
        } finally {
            btn.disabled = false;
            document.getElementById('btnText').innerText = originalText;
            // é—œé–‰æ‰‹æ©Ÿ Modal (å¦‚æœæœ‰é–‹)
            const modalEl = document.getElementById('mobileSaveModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if(modal) modal.hide();
        }
    }

    function updateLocalPortfolio(id, name, shares, cost) {
        // æª¢æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œè‹¥å­˜åœ¨å‰‡æ›´æ–°ï¼Œä¸å­˜åœ¨å‰‡æ–°å¢
        const index = portfolio.findIndex(p => p.id === id);
        if (index > -1) {
            portfolio[index].shares = parseFloat(shares);
            portfolio[index].cost = parseFloat(cost);
            if(name) portfolio[index].name = name;
        } else {
            // æ–°å¢æ™‚é è¨­æ®–åˆ©ç‡ç‚º 5% (å¾…åŒæ­¥æ›´æ–°)
            portfolio.push({ id, name, shares: parseFloat(shares), cost: parseFloat(cost), yield: 5.0, source: 'manual' });
        }
        saveData();
    }

    // --- B. CSV åŒæ­¥åŠŸèƒ½ (å¸‚å ´æ•¸æ“š) ---

    async function syncGoogleSheetData() {
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span> åŒæ­¥ä¸­...';
        
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL + '&t=' + Date.now());
            if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
            
            const csvText = await response.text();
            const rows = csvText.split('\n');
            let updateCount = 0;

            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',');
                if (cols.length < 5) continue; 

                const sheetId = cols[0].trim();
                const sheetYield = parseFloat(cols[4]); 

                const target = portfolio.find(p => p.id == sheetId);
                if (target && !isNaN(sheetYield)) {
                    target.yield = sheetYield;
                    target.source = 'GoogleSheet';
                    updateCount++;
                }
            }

            saveData();
            statusDiv.innerHTML = `<i class="bi bi-check-circle-fill text-success"></i> æ›´æ–° ${updateCount} ç­†æ•¸æ“š`;
            renderDashboard();

        } catch (error) {
            console.error(error);
            statusDiv.innerHTML = `<i class="bi bi-x-circle-fill text-danger"></i> åŒæ­¥å¤±æ•—`;
        }
    }

    // --- C. åŸºç¤åŠŸèƒ½ ---

    function loadData() {
        const stored = localStorage.getItem('myETFPortfolio');
        portfolio = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultPortfolio));
        updateSelectors();
    }

    function saveData() {
        localStorage.setItem('myETFPortfolio', JSON.stringify(portfolio));
        updateSelectors();
        renderDashboard();
    }

    function resetData() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) {
            localStorage.removeItem('myETFPortfolio');
            loadData();
            renderDashboard();
        }
    }

    function updateSelectors() {
        const sel = document.getElementById('etfSelector');
        const selMobile = document.getElementById('etfSelectorMobile');
        sel.innerHTML = '';
        selMobile.innerHTML = '';

        portfolio.forEach((etf, index) => {
            const option = `<option value="${index}">${etf.id} ${etf.name}</option>`;
            sel.innerHTML += option;
            selMobile.innerHTML += option;
        });
    }

    function syncMobileSelect(val) {
        document.getElementById('etfSelector').value = val;
        renderDashboard();
    }

    // --- D. æ¸²æŸ“ç•«é¢ ---

    function renderDashboard() {
        const index = document.getElementById('etfSelector').value || 0;
        if (portfolio.length === 0) return;
        
        const target = portfolio[index];
        const startShares = target.shares;
        const cost = target.cost || 0;
        const rate = target.yield / 100;

        // æ›´æ–°æ–‡å­—è³‡è¨Š
        document.getElementById('dashboardTitle').innerHTML = `<span class="badge bg-primary">${target.id}</span> ${target.name}`;
        document.getElementById('currentSharesDisplay').innerText = startShares.toFixed(2) + " å¼µ";
        document.getElementById('yieldDisplay').innerText = target.yield + "%";
        document.getElementById('costDisplay').innerText = cost > 0 ? `$${cost}` : "æœªè¼¸å…¥";
        
        const srcTag = document.getElementById('dataSourceTag');
        srcTag.innerHTML = target.source === 'GoogleSheet' ? '<span class="badge bg-success">è‡ªå‹•æ›´æ–°</span>' : '<span class="badge bg-secondary">æ‰‹å‹•</span>';

        // è¨ˆç®—è¤‡åˆ©
        let labels = [];
        let dataShares = [];
        let projectionHTML = '';
        let current = startShares;
        const targetYears = [1, 2, 3, 4, 5, 10];

        for (let year = 1; year <= 10; year++) {
            let prev = current;
            current = current * (1 + rate);
            let diff = current - prev;
            
            labels.push(`ç¬¬ ${year} å¹´`);
            dataShares.push(current.toFixed(2));
            
            const isMilestone = targetYears.includes(year);
            const rowClass = isMilestone ? "table-primary fw-bold" : "";
            
            projectionHTML += `
                <tr class="${rowClass}">
                    <td>${year} å¹´å¾Œ</td>
                    <td>${current.toFixed(2)} å¼µ</td>
                    <td class="text-success">+${diff.toFixed(2)} å¼µ</td>
                    <td>${((current / startShares) * 100).toFixed(0)}%</td>
                </tr>
            `;
        }

        document.getElementById('projectionTable').innerHTML = projectionHTML;
        document.getElementById('futureSharesDisplay').innerText = dataShares[9] + " å¼µ";
        
        const totalGrowth = ((dataShares[9] - startShares) / startShares * 100).toFixed(1);
        document.getElementById('growthRateDisplay').innerHTML = `<span class="growth-badge">+${totalGrowth}%</span>`;

        // ç¹ªåœ–
        const ctx = document.getElementById('compoundChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç´¯ç©å¼µæ•¸',
                    data: dataShares,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: false } }
            }
        });
    }
</script>

</body>
</html>
