<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF å­˜è‚¡æˆ°æƒ…å®¤ (é›²ç«¯åŒæ­¥ç‰ˆ)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { background-color: #ffffff; min-height: 100vh; border-right: 1px solid #dee2e6; }
        .card { border: none; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-radius: 10px; }
        .chart-container { position: relative; height: 400px; width: 100%; }
        .growth-badge { font-size: 0.9em; padding: 5px 10px; border-radius: 20px; background-color: #d1e7dd; color: #0f5132; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 col-lg-2 sidebar p-3 d-none d-md-block">
            <h5 class="text-primary mb-4"><i class="bi bi-graph-up-arrow"></i> å­˜è‚¡æˆ°æƒ…å®¤</h5>
            
            <div class="card mb-3 border-primary">
                <div class="card-header bg-primary text-white small py-1 fw-bold">
                    <i class="bi bi-cloud-upload"></i> æ–°å¢/å„²å­˜è‡³é›²ç«¯
                </div>
                <div class="card-body p-2">
                    <div class="mb-2">
                        <label class="form-label small mb-1 text-muted">ETF æœå°‹ (ä»£ç¢¼/åç¨±)</label>
                        <input class="form-control form-control-sm" list="etfOptions" id="inputCode" placeholder="è¼¸å…¥ 00..." onchange="autoFillName()">
                        <datalist id="etfOptions">
                            </datalist>
                        <input type="hidden" id="inputName">
                    </div>
                    <div class="row g-1 mb-2">
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="inputShares" placeholder="å¼µæ•¸" step="0.1">
                        </div>
                        <div class="col-6">
                            <input type="number" class="form-control form-control-sm" id="inputCost" placeholder="æˆæœ¬">
                        </div>
                    </div>
                    <button class="btn btn-primary btn-sm w-100" id="btnSave" onclick="saveToGoogleSheet()">
                        <span id="btnText">å„²å­˜è¨­å®š</span>
                    </button>
                </div>
            </div>

            <div class="alert alert-light border mb-3 p-2">
                <small class="text-muted d-block mb-2">é›²ç«¯æ•¸æ“šç‹€æ…‹</small>
                <div class="d-grid gap-1">
                     <button class="btn btn-outline-primary btn-sm" onclick="syncPortfolioFromCloud()">
                        <i class="bi bi-arrow-repeat"></i> ä¸‹è¼‰æˆ‘çš„åº«å­˜
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="syncGoogleSheetData()">
                        <i class="bi bi-graph-up"></i> æ›´æ–°å¸‚å ´æ®–åˆ©ç‡
                    </button>
                </div>
                <div id="syncStatus" class="small text-muted mt-1 text-center" style="font-size: 0.8em;"></div>
            </div>

            <div class="mb-3">
                <label class="form-label small text-muted">é¸æ“‡æˆ‘çš„æŒè‚¡</label>
                <select class="form-select" id="etfSelector" onchange="renderDashboard()">
                </select>
            </div>
            
            <div class="d-grid gap-2">
                <button class="btn btn-outline-danger btn-sm" onclick="resetData()">
                    <i class="bi bi-trash"></i> é‡ç½®æ‰€æœ‰è³‡æ–™
                </button>
            </div>
        </div>

        <div class="col-md-9 col-lg-10 p-4">
            <div class="d-md-none mb-3">
                <button class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#mobileSaveModal">
                    <i class="bi bi-cloud-upload"></i> æ–°å¢/ç®¡ç†
                </button>
                <select class="form-select mb-2" id="etfSelectorMobile" onchange="syncMobileSelect(this.value)">
                </select>
            </div>

            <h2 class="mb-4" id="dashboardTitle">è¼‰å…¥ä¸­...</h2>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-primary">
                        <div class="text-muted small">ç›®å‰æŒæœ‰å¼µæ•¸</div>
                        <div class="h2 fw-bold mb-0" id="currentSharesDisplay">0</div>
                        <div class="text-muted small mt-2">åˆå§‹æŠ•å…¥ / æˆæœ¬: <span id="costDisplay">-</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-success">
                        <div class="text-muted small">å¹³å‡å¹´åŒ–æ®–åˆ©ç‡ (é ä¼°)</div>
                        <div class="h2 fw-bold mb-0 text-success" id="yieldDisplay">0%</div>
                        <div class="text-muted small mt-2">æ•¸æ“šä¾†æºï¼š<span id="dataSourceTag">è‡ªè¨‚</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card p-3 h-100 border-start border-5 border-warning">
                        <div class="text-muted small">10 å¹´å¾Œé ä¼°ç´¯ç©</div>
                        <div class="h2 fw-bold mb-0 text-warning" id="futureSharesDisplay">0</div>
                        <div class="text-muted small mt-2">ç¸½è³‡ç”¢æˆé•· <span id="growthRateDisplay"></span></div>
                    </div>
                </div>
            </div>

            <div class="card p-4 mb-4">
                <h5 class="card-title">ğŸ“Š è¤‡åˆ©æˆé•·è¦–è¦ºåŒ– (10å¹´æ¨æ¼”)</h5>
                <div class="chart-container">
                    <canvas id="compoundChart"></canvas>
                </div>
            </div>

            <div class="card p-4">
                <h5 class="card-title">ğŸ“… å¹´åº¦æˆé•·é ä¼°è¡¨</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>å¹´åº¦</th>
                                <th>ç´¯ç©å¼µæ•¸ (Shares)</th>
                                <th>å¢åŠ å¼µæ•¸ (ä¾†è‡ªè‚¡æ¯)</th>
                                <th>æˆé•·å€ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="projectionTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="mobileSaveModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢/å„²å­˜è‡³é›²ç«¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ETF ä»£ç¢¼</label>
                    <input class="form-control" list="etfOptions" id="inputCodeMobile" onchange="document.getElementById('inputCode').value=this.value; autoFillName();">
                </div>
                <div class="mb-3">
                    <label class="form-label">å¼µæ•¸</label>
                    <input type="number" class="form-control" id="inputSharesMobile" onchange="document.getElementById('inputShares').value=this.value">
                </div>
                 <div class="mb-3">
                    <label class="form-label">æˆæœ¬</label>
                    <input type="number" class="form-control" id="inputCostMobile" onchange="document.getElementById('inputCost').value=this.value">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary w-100" onclick="saveToGoogleSheet();">ç¢ºèªå„²å­˜</button>
                <button type="button" class="btn btn-outline-primary w-100 mt-2" onclick="syncPortfolioFromCloud();" data-bs-dismiss="modal">ä¸‹è¼‰æˆ‘çš„åº«å­˜</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================
    // ğŸ”§ è¨­å®šå€ (Config)
    // ============================================================
    
    // 1. Google Apps Script
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwa5A867o-bWRfzoMNuufTGYE-vdkmNlYs_mE6TwshaAgD-aZQQOQuQ8DKDrVCIUyVp/exec";

    // 2. Google Sheet CSV
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR4QoHaM5u03EpqWIbYkJaj749HPEzD3VwQQMvxDzjcOKYU-NWFiZymKwLpBWhLcGQdhZtqMigya-sN/pub?gid=1762648152&single=true&output=csv'; 

    // é è¨­ç©ºè³‡æ–™
    const defaultPortfolio = [];

    let portfolio = [];
    let chartInstance = null;

    // ============================================================
    // ğŸš€ æ ¸å¿ƒé‚è¼¯
    // ============================================================

    window.onload = function() {
        loadData();             // 1. å˜—è©¦è®€å–å¿«å– (å¯èƒ½æ˜¯ç©ºçš„)
        initMarketList();       // 2. è¼‰å…¥æœå°‹æ¸…å–®
        syncPortfolioFromCloud(); // 3. [æ–°å¢é—œéµæ­¥é©Ÿ] ä¸»å‹•å»é›²ç«¯æŠ“è³‡æ–™ï¼
        // syncGoogleSheetData(); // 4. (å¯é¸) åŒæ­¥å®Œåº«å­˜å¾Œï¼Œå†è‡ªå‹•æ›´æ–°æ®–åˆ©ç‡ï¼Œé€™è£¡å…ˆä¸è‡ªå‹•è·‘é¿å…å¡ä½
    };

    // --- A. é›²ç«¯å­˜å– (GAS) ---
    
    // æ–°å¢ï¼šå¾é›²ç«¯æ‹‰å–åº«å­˜
    async function syncPortfolioFromCloud() {
        const statusDiv = document.getElementById('syncStatus');
        statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ä¸‹è¼‰åº«å­˜ä¸­...';
        
        try {
            // å‘¼å« GAS çš„ doGet(action=getPortfolio)
            const res = await fetch(GAS_API_URL + "?action=getPortfolio");
            const data = await res.json();
            
            if (Array.isArray(data) && data.length > 0) {
                console.log("æˆåŠŸå¾é›²ç«¯ä¸‹è¼‰åº«å­˜:", data);
                
                // æ ¼å¼è½‰æ›èˆ‡åˆä½µ
                // æˆ‘å€‘éœ€è¦ä¿ç•™æœ¬åœ°çš„ yield (å¦‚æœæœ‰çš„è©±)ï¼Œæˆ–è€…é è¨­ç‚º 5%
                // é›²ç«¯è³‡æ–™çµæ§‹: {id, name, shares, cost}
                
                // æ¸…ç©ºä¸¦é‡æ–°å¡«å…¥
                portfolio = data.map(item => ({
                    id: item.id,
                    name: item.name,
                    shares: Number(item.shares),
                    cost: Number(item.cost),
                    yield: 5.0, // é è¨­å€¼ï¼Œç¨å¾Œç”± CSV æ›´æ–°ä¿®æ­£
                    source: 'cloud'
                }));

                saveData(); // æ›´æ–°æœ¬åœ°å¿«å–
                statusDiv.innerHTML = `<i class="bi bi-cloud-check text-success"></i> å·²ä¸‹è¼‰ ${data.length} ç­†åº«å­˜`;
                
                // ä¸‹è¼‰å®Œåº«å­˜å¾Œï¼Œé †ä¾¿å»æ›´æ–°ä¸€ä¸‹æ®–åˆ©ç‡
                syncGoogleSheetData();
                
            } else {
                statusDiv.innerHTML = `<span class="text-muted">é›²ç«¯ç„¡è³‡æ–™</span>`;
                if(portfolio.length === 0) {
                    document.getElementById('dashboardTitle').innerText = "å°šç„¡æŒè‚¡è³‡æ–™ï¼Œè«‹å…ˆæ–°å¢";
                }
            }
        } catch (e) {
            console.error("ä¸‹è¼‰åº«å­˜å¤±æ•—", e);
            statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle text-warning"></i> ä¸‹è¼‰å¤±æ•—`;
        }
    }

    async function initMarketList() {
        try {
            const res = await fetch(GAS_API_URL + "?action=getMarketList");
            const list = await res.json();
            const datalist = document.getElementById('etfOptions');
            datalist.innerHTML = '';
            list.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id; 
                option.label = item.name; 
                datalist.appendChild(option);
            });
            window.marketData = list; 
        } catch (e) { console.error(e); }
    }

    function autoFillName() {
        const val = document.getElementById('inputCode').value;
        if(window.marketData) {
            const found = window.marketData.find(item => item.id === val);
            if (found) document.getElementById('inputName').value = found.name;
        }
    }

    async function saveToGoogleSheet() {
        const id = document.getElementById('inputCode').value;
        const name = document.getElementById('inputName').value || id;
        const shares = document.getElementById('inputShares').value;
        const cost = document.getElementById('inputCost').value || 0;

        if (!id || !shares) { alert("è«‹è¼¸å…¥ä»£ç¢¼èˆ‡å¼µæ•¸ï¼"); return; }

        const btn = document.getElementById('btnSave');
        const originalText = document.getElementById('btnText').innerText;
        btn.disabled = true;
        document.getElementById('btnText').innerText = "å„²å­˜ä¸­...";

        try {
            const payload = { id, name, shares, cost };
            await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify(payload) });
            
            // æ›´æ–°æœ¬åœ°
            updateLocalPortfolio(id, name, shares, cost);
            alert(`âœ… ${id} å·²å„²å­˜è‡³é›²ç«¯ï¼`);
            
            document.getElementById('inputCode').value = '';
            document.getElementById('inputShares').value = '';
            document.getElementById('inputCost').value = '';
        } catch (e) {
            console.error(e);
            alert("âš ï¸ å„²å­˜è«‹æ±‚å·²ç™¼é€ã€‚");
            updateLocalPortfolio(id, name, shares, cost);
        } finally {
            btn.disabled = false;
            document.getElementById('btnText').innerText = originalText;
            const modal = bootstrap.Modal.getInstance(document.getElementById('mobileSaveModal'));
            if(modal) modal.hide();
        }
    }

    function updateLocalPortfolio(id, name, shares, cost) {
        const index = portfolio.findIndex(p => p.id === id);
        if (index > -1) {
            portfolio[index].shares = parseFloat(shares);
            portfolio[index].cost = parseFloat(cost);
            if(name) portfolio[index].name = name;
        } else {
            portfolio.push({ id, name, shares: parseFloat(shares), cost: parseFloat(cost), yield: 5.0, source: 'manual' });
        }
        saveData();
    }

    // --- B. CSV åŒæ­¥ (Market Data) ---
    async function syncGoogleSheetData() {
        const statusDiv = document.getElementById('syncStatus');
        // é¿å…è¦†è“‹æ‰ä¸‹è¼‰åº«å­˜çš„è¨Šæ¯ï¼Œåªåœ¨é‚„æ²’ä¸‹è¼‰æ™‚é¡¯ç¤º
        if(!statusDiv.innerHTML.includes("å·²ä¸‹è¼‰")) {
            statusDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span> æ›´æ–°æ®–åˆ©ç‡...';
        }
        
        try {
            const response = await fetch(GOOGLE_SHEET_CSV_URL + '&t=' + Date.now());
            if (!response.ok) throw new Error("é€£ç·šå¤±æ•—");
            
            const csvText = await response.text();
            const rows = csvText.split('\n');
            let updateCount = 0;

            for (let i = 1; i < rows.length; i++) {
                const cols = rows[i].split(',');
                if (cols.length < 4) continue;

                const sheetId = cols[0].trim();
                // æ™ºæ…§æ¬„ä½åµæ¸¬ (é˜² 2025 å¹´ä»½å•é¡Œ)
                let rawYield = parseFloat(cols[4]); 
                if (isNaN(rawYield) || rawYield > 100) {
                    let altYield = parseFloat(cols[3]);
                    if (!isNaN(altYield) && altYield < 100) rawYield = altYield;
                }
                const sheetYield = rawYield;

                if (isNaN(sheetYield) || sheetYield > 100 || sheetYield <= 0) continue; 

                const target = portfolio.find(p => p.id == sheetId);
                if (target) {
                    target.yield = sheetYield;
                    target.source = 'GoogleSheet';
                    updateCount++;
                }
            }

            saveData();
            // å¦‚æœæœ‰æ›´æ–°ï¼Œé¡¯ç¤ºç‹€æ…‹
            if(updateCount > 0) {
                statusDiv.innerHTML += ` <span class="text-success"> | æ®–åˆ©ç‡å·²æ›´æ–°</span>`;
            }
            renderDashboard();

        } catch (error) {
            console.error(error);
        }
    }

    // --- C. åŸºç¤åŠŸèƒ½ ---
    function loadData() {
        const stored = localStorage.getItem('myETFPortfolio');
        // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œå°±çµ¦ç©ºé™£åˆ—ï¼Œä¸è¦çµ¦é è¨­å€¼äº†ï¼Œä»¥å…æ··æ·†
        portfolio = stored ? JSON.parse(stored) : [];
        
        // åˆå§‹æ¸²æŸ“ï¼Œè‹¥ç‚ºç©ºå‰‡é¡¯ç¤ºæç¤º
        updateSelectors();
        if(portfolio.length === 0) {
            document.getElementById('dashboardTitle').innerText = "è¼‰å…¥ä¸­...";
        } else {
            renderDashboard();
        }
    }

    function saveData() {
        localStorage.setItem('myETFPortfolio', JSON.stringify(portfolio));
        updateSelectors();
        renderDashboard();
    }

    function resetData() {
        if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ(é€™åªæœƒæ¸…ç©ºæœ¬æ©Ÿå¿«å–ï¼Œé›²ç«¯è³‡æ–™é‚„åœ¨)")) {
            localStorage.removeItem('myETFPortfolio');
            loadData();
            document.getElementById('dashboardTitle').innerText = "å·²é‡ç½®ï¼Œè«‹é‡æ–°ä¸‹è¼‰åº«å­˜";
            renderDashboard(); // clear view
        }
    }

    function updateSelectors() {
        const sel = document.getElementById('etfSelector');
        const selMobile = document.getElementById('etfSelectorMobile');
        sel.innerHTML = '';
        selMobile.innerHTML = '';
        portfolio.forEach((etf, index) => {
            const option = `<option value="${index}">${etf.id} ${etf.name}</option>`;
            sel.innerHTML += option;
            selMobile.innerHTML += option;
        });
    }

    function syncMobileSelect(val) {
        document.getElementById('etfSelector').value = val;
        renderDashboard();
    }

    // --- D. æ¸²æŸ“ç•«é¢ ---
    function renderDashboard() {
        const index = document.getElementById('etfSelector').value || 0;
        
        // è™•ç†ç©ºè³‡æ–™ç‹€æ³
        if (portfolio.length === 0) {
            document.getElementById('dashboardTitle').innerText = "å°šç„¡è³‡æ–™ (è«‹æŒ‰ã€Œä¸‹è¼‰æˆ‘çš„åº«å­˜ã€)";
            document.getElementById('currentSharesDisplay').innerText = "-";
            document.getElementById('yieldDisplay').innerText = "-";
            document.getElementById('costDisplay').innerText = "-";
            document.getElementById('futureSharesDisplay').innerText = "-";
            document.getElementById('growthRateDisplay').innerText = "";
            document.getElementById('projectionTable').innerHTML = "";
            if(chartInstance) chartInstance.destroy();
            return;
        }
        
        const target = portfolio[index];
        const startShares = target.shares;
        const cost = target.cost || 0;
        const rate = target.yield / 100;

        document.getElementById('dashboardTitle').innerHTML = `<span class="badge bg-primary">${target.id}</span> ${target.name}`;
        document.getElementById('currentSharesDisplay').innerText = startShares.toFixed(2) + " å¼µ";
        document.getElementById('yieldDisplay').innerText = target.yield + "%";
        document.getElementById('costDisplay').innerText = cost > 0 ? `$${cost}` : "æœªè¼¸å…¥";
        
        const srcTag = document.getElementById('dataSourceTag');
        srcTag.innerHTML = target.source === 'GoogleSheet' ? '<span class="badge bg-success">è‡ªå‹•æ›´æ–°</span>' : '<span class="badge bg-secondary">æ‰‹å‹•/é›²ç«¯</span>';

        let labels = [];
        let dataShares = [];
        let projectionHTML = '';
        let current = startShares;
        const targetYears = [1, 2, 3, 4, 5, 10];

        for (let year = 1; year <= 10; year++) {
            let prev = current;
            current = current * (1 + rate);
            let diff = current - prev;
            labels.push(`ç¬¬ ${year} å¹´`);
            dataShares.push(current.toFixed(2));
            
            const isMilestone = targetYears.includes(year);
            const rowClass = isMilestone ? "table-primary fw-bold" : "";
            
            projectionHTML += `<tr class="${rowClass}"><td>${year} å¹´å¾Œ</td><td>${current.toFixed(2)} å¼µ</td><td class="text-success">+${diff.toFixed(2)} å¼µ</td><td>${((current / startShares) * 100).toFixed(0)}%</td></tr>`;
        }

        document.getElementById('projectionTable').innerHTML = projectionHTML;
        document.getElementById('futureSharesDisplay').innerText = dataShares[9] + " å¼µ";
        const totalGrowth = ((dataShares[9] - startShares) / startShares * 100).toFixed(1);
        document.getElementById('growthRateDisplay').innerHTML = `<span class="growth-badge">+${totalGrowth}%</span>`;

        const ctx = document.getElementById('compoundChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ç´¯ç©å¼µæ•¸',
                    data: dataShares,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } } }
        });
    }
</script>
</body>
</html>

